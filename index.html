<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Renatus Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/map/favicon.png">
  <link rel="shortcut icon" type="image/x-icon" href="/map/favicon.ico">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />


  <style>
    html, body {
      margin: 0;
      height: 100dvh;
      background: #00000000;
      overflow: hidden;
    }

    #overlay-buttons {
      pointer-events: auto;
      z-index: 9999;
    }

    #btn-grid {
      pointer-events: auto;
      cursor: pointer;
      z-index: 9999;
    }

    #category-info-box {
      position: absolute;
      top: 27%;
      left: 2.2%;
      width: 16dvh;
      background: rgba(0, 0, 0, 0);
      color: rgba(171, 255, 171, 0.548);
      padding: 1dvh;
      font-family: 'Courier New', monospace;
      border-radius: 0.5dvh;
      font-size: 2.4dvh;
      z-index: 201;
      pointer-events: none;
      text-transform: uppercase;
      text-align: center;
    }

    #category-info-box span {
      display: block;
      font-size: 1.7dvh;
      font-weight: normal;
      text-transform: none;
      margin-top: 1.6dvh;
      text-align: left; /* default */
    }

    #category-info-box.align-left span {
      text-align: left;
      padding-left: 0.6dvh;
    }

    #category-info-box.align-right span {
      text-align: right;
      padding-right: 0.6dvh;
    }

    #control-panel-wrapper {
      position: fixed;
      top: 0;
      left: 50%;
      height: 100dvh;
      transform: translateX(-50%);
      z-index: 0;
      pointer-events: none;
    }

    #control-panel-base {
      height: 100dvh;
    }

    #tv-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 100dvh;
      height: 100dvh;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 3;
      background: url('tv-frame.png') center center no-repeat;
      background-size: contain;
    }
    
    #gap-fix-overlay {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      height: 100dvh;
      pointer-events: none;
      z-index: 99999;
      background-size: contain;
    }

    #floating-labels {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    .floating-label {
      position: absolute;
      color: #c0ffc0;
      font-family: 'Courier New', monospace;
      font-size: 2dvh;
      white-space: nowrap;
      text-shadow:
        0 0 2px #7fff7f,
        0 0 6px #aaffaa,
        0 0 12px #c0ffc0,
        0 0 18px #c0ffc0,
        0 0 24px #e0ffe0;
      pointer-events: none;
      z-index: 9999;
    }

      #background {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 100vw;
      height: 100vw;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: -1;
      background: url('background.png') center center no-repeat;
      background-size: contain;
    }
    #map-container {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 100dvh;
      height: 100dvh;
      transform: translate(-50%, -50%);
      max-width: 100dvh;
      max-height: 100dvh;
      overflow: hidden;
      opacity: 0;
      transition: opacity 1s ease-in;
      display: none;
      z-index: 1;
    }

    #map {
      width: 100%;
      height: 100%;
      z-index: 1;
      background: transparent;
      position: relative;
    }

    #background-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('tv-background.png') center center no-repeat;
      background-size: cover;
      z-index: 0;
      pointer-events: none;
    }

    #coord-input {
      position: absolute;
      top: 43.1%;
      left: 91.7%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0);
      width: 18dvh;
      height: 3.8dvh;
      vertical-align: middle;
      font-size: 3.8dvh;
      padding: 0dvh;
      border-radius: 0.8dvh;
      font-family: 'Courier New', monospace;
      font-size: 1.8dvh;
      z-index: 9999;
      pointer-events: auto;
    }

    #coord-input input {
      width: 18dvh;
      height: 3.8h;
      font-size: 1.4dvh;
      font-family: 'Courier New', monospace;
      background: none;
      border: none;
      color: rgba(171, 255, 171, 0.74);
      outline: none;
      text-align: center;
      box-sizing: border-box;

      padding-top: 1dvh;
      padding-bottom: 0.2dvh;
      line-height: normal;
    }

    #map-container.grayscale {
      filter: grayscale(100%) contrast(180%);
    }

    #coord-input input::placeholder {
      color: #c0ffc0;
      opacity: 0.7;
    }

    #map-container.rainbow-mode {
      animation: rainbowShift 8s linear infinite;
      filter: hue-rotate(0deg);
    }

    @keyframes rainbowShift {
      0%   { filter: hue-rotate(0deg); }
      100% { filter: hue-rotate(360deg); }
    }

    #overlay-buttons {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: auto;
      z-index: 200;
    }

    .map-toggle-btn {
      position: absolute;
      width: 4dvh;
      height: 4dvh;
      pointer-events: auto;
      transition: opacity 0.3s ease;
      cursor: pointer;
      opacity: 0.5;
    }

    .layer-toggle {
      width: 6.25dvh;
      height: 2.5dvh;
      opacity: 1;
    }

    .dummy-button {
      pointer-events: none;
      opacity: 1;
    }

    .onoff-toggle {
      opacity: 0.8 !important;
      height: 6.2dvh;
      width: auto;
      transform-origin: center center;
    }

    #btn-map-toggle {
      opacity: 1;
    }

    * {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    .status-light {
      position: absolute;
      width: 4dvh;
      height: 4dvh;
      pointer-events: none;
    }
    #btn-grid {
      pointer-events: auto;
      cursor: pointer;
      z-index: 9999;
    }
    #btn-map-toggle { top: 82.5%; left: 90.52%; transform: scale(4); }
    #status-light   { top: 5.8%; left: 90.22%; pointer-events: none; transform: scale(2.6); }

    .pulse-marker {
      position: absolute;
      width: 20px;
      height: 20px;
      position: absolute;
      background: #c0ffc0;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 999;
    }

    .map-text-label {
      font-family: 'Courier New', monospace;
      color: #c0ffc0; /* original green text */
      font-size: 1.6dvh;
      text-align: center;
      white-space: nowrap;
      pointer-events: none;
      text-shadow:
        0 0 2px #7fff7f,     /* soft core glow */
        0 0 6px #aaffaa,     /* lighter halo */
        0 0 12px #c0ffc0,    /* matches text */
        0 0 18px #c0ffc0,    /* soft outer aura */
        0 0 24px #e0ffe0;    /* subtle neon fade */
      z-index: 9999;
    }

    .clear {
      height: 10dvh;
      width: auto;
      opacity: 0.8 !important;
    }

    .pulse-marker::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      background: #c0ffc0;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: pulse 1.5s ease-out infinite;
    }

    .faint-marker {
      width: 8px;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid white;
      border-radius: 50%;
      pointer-events: none;
      position: absolute;
    }

    .numpad-btn {
      width: 5.2dvh;
      height: auto;
      cursor: pointer;
      opacity: 1 !important;
    }

    .mode-toggle {
      height: 5dvh;
      width: auto;
      opacity: 1 !important;
    }

    .category-light {
      width: 2.2dvh;
      height: 2.2dvh;
      pointer-events: none;
      z-index: 9999;
    }

    .measure-toggle {
      width: 16dvh;
      height: auto;
      opacity: 1 !important;
    }
    .leaflet-control-measure .leaflet-control-measure-toggle,
    .leaflet-control-measure .leaflet-control-measure-interaction {
      display: none !important;
    }
    @keyframes pulse {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.8;
      }
      100% {
        transform: translate(-50%, -50%) scale(2.5);
        opacity: 0;
      }
    }
    #discord-button {
      position: fixed;
      bottom: 2vh;
      right: 2vh;
      z-index: 999999;
      display: block;
      height: 4vh !important;
      width: auto;
      transition: transform 0.2s ease;
      pointer-events: auto;
    }
    #discord-button img {
      height: 4vh;
      width: auto;
      display: block;
    }
    #discord-button:hover {
      transform: scale(1.08);
    }
  </style>
</head>
<body>
  <div id="control-panel-wrapper">
    <img id="control-panel-base" src="control-panel-base.png" alt="" />
    <div id="overlay-buttons">
      <img src="switch-on.png" id="btn-map-on" class="map-toggle-btn onoff-toggle" style="top: 83.5%; left: 85.42%;" draggable="false"/>
      <img src="switch-off.png" id="btn-map-off" class="map-toggle-btn onoff-toggle" style="top: 83.5%; left: 91.52%;" draggable="false"/>
      <img src="light-off.png" id="status-light" class="status-light" />
      <!-- Category: Zones -->
      <img src="button-a.png" id="btn-cat-zones" class="map-toggle-btn category-toggle" data-category="cat-zones" data-state="off" style="top: 55.1%; left: 3%; opacity: 1;" draggable="false" />
      <img src="indicator-off.png" id="light-cat-zones" class="status-light category-light" style="top: 55.9%; left: 6.1%;" draggable="false" />

      <!-- Category: Environment -->
      <img src="button-b.png" id="btn-cat-env" class="map-toggle-btn category-toggle" data-category="cat-env" data-state="off" style="top: 59.1%; left: 3%; opacity: 1;" draggable="false" />
      <img src="indicator-off.png" id="light-cat-env" class="status-light category-light" style="top: 59.9%; left: 6.1%;" draggable="false" />

      <!-- Category: Manmade -->
      <img src="button-c.png" id="btn-cat-manmade" class="map-toggle-btn category-toggle" data-category="cat-manmade" data-state="off" style="top: 63.1%; left: 3%; opacity: 1;" draggable="false" />
      <img src="indicator-off.png" id="light-cat-manmade" class="status-light category-light" style="top: 63.9%; left: 6.1%;" draggable="false" />

      <!-- Category: Traversal -->
      <img src="button-d.png" id="btn-cat-traversal" class="map-toggle-btn category-toggle" data-category="cat-traversal" data-state="off" style="top: 67.1%; left: 3%; opacity: 1;" draggable="false" />
      <img src="indicator-off.png" id="light-cat-traversal" class="status-light category-light" style="top: 67.9%; left: 6.1%;" draggable="false" />

      <!-- Category: Labels -->
      <img src="button-e.png" id="btn-cat-labels" class="map-toggle-btn category-toggle" data-category="cat-labels" data-state="off" style="top: 71.1%; left: 3%; opacity: 1;" draggable="false" />
      <img src="indicator-off.png" id="light-cat-labels" class="status-light category-light" style="top: 71.9%; left: 6.1%;" draggable="false" />

      <img src="tickletoggle-off.png" id="btn-tickletoggle" class="map-toggle-btn" data-state="off" style="top: 1.8%;  right: 1.5%; z-index: 9999; opacity: 0.75;" draggable="false" />
      <div id="tickle-counter" style="position: absolute; top: 49%; left: 9.5%;  width: 6dvh; height: auto; color: rgba(171, 255, 171, 0.548); font-family: 'Courier New', monospace; font-size: 1.5dvh; text-align: right; white-space: nowrap; overflow: hidden; pointer-events: none; z-index: 9999; display: none;">0</div>

      <div id="cat-zones" class="overlay-category" style="display:none;">
        <img src="layerbutton-off.png" id="btn-patrol" class="map-toggle-btn layer-toggle" data-state="off" style="top: 55.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-migration" class="map-toggle-btn layer-toggle" data-state="off" style="top: 59.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-sanctuary" class="map-toggle-btn layer-toggle" data-state="off" style="top: 63.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 67.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 71.8%; left: 10%;" draggable="false"/>
      </div>

      <div id="cat-env" class="overlay-category" style="display:none;">
        <img src="layerbutton-off.png" id="btn-water" class="map-toggle-btn layer-toggle" data-state="off" style="top: 55.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-salt" class="map-toggle-btn layer-toggle" data-state="off" style="top: 59.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-mud" class="map-toggle-btn layer-toggle" data-state="off" style="top: 63.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 67.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 71.8%; left: 10%;" draggable="false"/>
      </div>

      <div id="cat-manmade" class="overlay-category" style="display:none;">
        <img src="layerbutton-off.png" id="btn-road" class="map-toggle-btn layer-toggle" data-state="off" style="top: 55.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-structure" class="map-toggle-btn layer-toggle" data-state="off" style="top: 59.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 63.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 67.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 71.8%; left: 10%;" draggable="false"/>
      </div>

      <div id="cat-traversal" class="overlay-category" style="display:none;">
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 55.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 59.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 63.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 67.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 71.8%; left: 10%;" draggable="false"/>
      </div>

      <div id="cat-labels" class="overlay-category" style="display:none;">
        <img src="layerbutton-off.png" id="btn-lakes" class="map-toggle-btn layer-toggle" data-state="off" style="top: 55.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-rivers" class="map-toggle-btn layer-toggle" data-state="off" style="top: 59.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-outposts" class="map-toggle-btn layer-toggle" data-state="off" style="top: 63.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-landmarks" class="map-toggle-btn layer-toggle" data-state="off" style="top: 67.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 71.8%; left: 10%;" draggable="false"/>
      </div>

      <div id="dummy-fillers">
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 55.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 59.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 63.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 67.8%; left: 10%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 71.8%; left: 10%;" draggable="false"/>
      </div>

      <div id="numpad-container" style="
        position: absolute;
        top: 60.8%;
        left: 91.7%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        display: flex;
        flex-wrap: wrap;
        width: 18dvh;
        height: auto;
        justify-content: center;
        gap: 0.4dvh;
        pointer-events: auto;
      ">
        <!-- Number buttons -->
        <img src="button-1.png" id="btn-numpad-1" class="numpad-btn" data-num="1" draggable="false" />
        <img src="button-2.png" id="btn-numpad-2" class="numpad-btn" data-num="2" draggable="false" />
        <img src="button-3.png" id="btn-numpad-3" class="numpad-btn" data-num="3" draggable="false" />
        <img src="button-4.png" id="btn-numpad-4" class="numpad-btn" data-num="4" draggable="false" />
        <img src="button-5.png" id="btn-numpad-5" class="numpad-btn" data-num="5" draggable="false" />
        <img src="button-6.png" id="btn-numpad-6" class="numpad-btn" data-num="6" draggable="false" />
        <img src="button-7.png" id="btn-numpad-7" class="numpad-btn" data-num="7" draggable="false" />
        <img src="button-8.png" id="btn-numpad-8" class="numpad-btn" data-num="8" draggable="false" />
        <img src="button-9.png" id="btn-numpad-9" class="numpad-btn" data-num="9" draggable="false" />
        <!-- Clear, 0, Confirm -->
        <img src="button-clear.png" id="btn-numpad-clear" class="numpad-btn" draggable="false" />
        <img src="button-0.png" id="btn-numpad-0" class="numpad-btn" data-num="0" draggable="false" />
        <img src="button-confirm.png" id="btn-numpad-confirm" class="numpad-btn" draggable="false" />
        <img src="button-space.png" id="btn-numpad-space" class="numpad-btn" draggable="false" style="width: 16dvh; height: auto; margin-top: 0.6dvh;" />
      </div>

      <!-- Grid -->
      <img src="modebutton-off.png" id="btn-grid" class="map-toggle-btn mode-toggle" data-state="off" style="top: 18.8%; left: 11.8%;" draggable="false"/>
      <img src="indicator-off.png" id="light-grid" class="status-light category-light" style="top: 16.5%; left: 12.1%;" draggable="false"/>

      <!-- Topography -->
      <img src="modebutton-off.png" id="btn-topo-mode" class="map-toggle-btn mode-toggle" data-state="off" style="top: 18.8%; left: 8.8%;" draggable="false"/>
      <img src="indicator-off.png" id="light-topo" class="status-light category-light" style="top: 16.5%; left: 9.1%;" draggable="false"/>

      <!-- Contrast -->
      <img src="modebutton-off.png" id="btn-contrast-mode" class="map-toggle-btn mode-toggle" data-state="off" style="top: 18.8%; left:5.8%;" draggable="false"/>
      <img src="indicator-off.png" id="light-contrast" class="status-light category-light" style="top: 16.5%; left: 6.1%;" draggable="false"/>

      <!-- Base 1 -->
      <img src="modebutton-off.png" id="btn-base1" class="map-toggle-btn mode-toggle" data-state="off" style="top: 18.8%; left: 2.8%;" draggable="false"/>
      <img src="indicator-off.png" id="light-base1" class="status-light category-light" style="top: 16.5%; left: 3.1%;" draggable="false"/>

      <img src="measure-off.png" id="btn-measure" class="map-toggle-btn measure-toggle" data-state="off" style="top: 32.8%;  left: 86.42%;" draggable="false"/>
      <div id="coord-input" style="display: none;">
        <input type="text" id="coord-full" placeholder="Paste coords" />
      </div>
      <div id="measure-display" style="
        position: absolute;
        top: 27.2%;
        right: 2.2%;
        width: 15.5dvh;
        color: rgba(171, 255, 171, 0.74);
        font-family: 'Courier New', monospace;
        font-size: 1.5dvh;
        z-index: 9999;
        background: rgba(0,0,0,0);
        padding: 0.6dvh 1.2dvh;
        border-radius: 1dvh;
        display: none;
        pointer-events: none;
      "></div>
      <div id="category-info-box" style="display: none;"></div>
    </div>
  </div>

  <div id="map-container">
    <div id="background-overlay"></div>
    <div id="map"></div>
  </div>
  <div id="floating-labels" style="display: none;"></div>
  <div id="tv-overlay"></div>
  <div id="background"></div>

  <audio id="sound-on" src="monitor-on.mp3"></audio>
  <audio id="sound-off" src="monitor-off.mp3"></audio>
  <audio id="click-sound" src="click.mp3"></audio>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-curve"></script>
  <script>
    let goreOverlayVisible = false;
    let goreOverlay;
    let btnGrid;
    let gridLayerGroup;
    let coordPathPoints = [];
    let coordPathLayer = null;
    let coordStartMarker = null;
    let coordEndMarker = null;
    const mapLabels = [
    ];

    const map = L.map('map', {
      crs: L.CRS.Simple,
      zoomControl: false,
      maxBounds: [[0, 0], [4096, 4096]],
      maxBoundsViscosity: 1.0
    });
    const coordLayerGroup = L.layerGroup().addTo(map);

    function pressButtonImage(button, pressedSrc, defaultSrc, delay = 50) {
      button.src = pressedSrc;
      setTimeout(() => {
        button.src = defaultSrc;
      }, delay);
    }
    function setInfoBoxAlignment(align = "left") {
      const infoBox = document.getElementById('category-info-box');
      infoBox.classList.remove('align-left', 'align-right');
      infoBox.classList.add(`align-${align}`);
    }
    function setMinZoomToFitViewport(maxHeightInDvh = 100) {
      const mapHeightInPixels = window.innerHeight * (maxHeightInDvh / 100);
      const mapWidthInPixels = map.getContainer().clientWidth;

      const scaleY = mapHeightInPixels / 4096;
      const scaleX = mapWidthInPixels / 4096;

      const scale = Math.min(scaleX, scaleY) * 0.9;
      const zoom = map.getScaleZoom(scale, 0);

      map.setMinZoom(zoom);
    }


    function setMinZoomToFitMap() {
      const bounds = [[0, 0], [4096, 4096]];
      const minZoom = map.getBoundsZoom(bounds, false); // false = fit inside view
      map.setMinZoom(minZoom);
    }

    setMinZoomToFitMap();

    const mapSize = 4096;
    const imageBounds = [[0, 0], [mapSize, mapSize]];

    map.createPane('base'); map.getPane('base').style.zIndex = 200;
    map.createPane('base1'); map.getPane('base1').style.zIndex = 201;
    map.createPane('topography'); map.getPane('topography').style.zIndex = 250;
    map.createPane('water'); map.getPane('water').style.zIndex = 300;
    map.createPane('terrain'); map.getPane('terrain').style.zIndex = 400;
    map.createPane('road'); map.getPane('road').style.zIndex = 500;
    map.createPane('salt'); map.getPane('salt').style.zIndex = 600;
    map.createPane('mud'); map.getPane('mud').style.zIndex = 600;
    map.createPane('structure'); map.getPane('structure').style.zIndex = 700;
    map.createPane('sanctuary'); map.getPane('sanctuary').style.zIndex = 800;
    map.createPane('migration'); map.getPane('migration').style.zIndex = 850;
    map.createPane('patrol'); map.getPane('patrol').style.zIndex = 900;
    map.createPane('labels'); map.getPane('labels').style.zIndex = 1000;
    map.createPane('measure');
    map.getPane('measure').style.zIndex = 9989;

    const baseLayer = L.imageOverlay('map-base.png', imageBounds, { pane: 'base' }).addTo(map);
    const terrainLayer = L.imageOverlay('terrain-line.png', imageBounds, { pane: 'terrain' }).addTo(map);
    const base1Layer = L.imageOverlay('map-base1.png', imageBounds, { pane: 'base1' });
    const waterLayer = L.imageOverlay('water-layer.png', imageBounds, { pane: 'water' });
    const saltLayer = L.imageOverlay('salt-layer.png', imageBounds, { pane: 'salt', opacity: 0.8 });
    const mudLayer = L.imageOverlay('mud-layer.png', imageBounds, { pane: 'mud', opacity: 0.8 });
    const roadLayer = L.imageOverlay('road-layer.png', imageBounds, { pane: 'road', opacity: 0.8 });
    const structureLayer = L.imageOverlay('structure-layer.png', imageBounds, { pane: 'structure', opacity: 0.8 });
    const sanctuaryLayer = L.imageOverlay('sanctuary-layer.png', imageBounds, { pane: 'sanctuary' });
    const migrationLayer = L.imageOverlay('migration-layer.png', imageBounds, { pane: 'migration' });
    const patrolLayer = L.imageOverlay('patrol-layer.png', imageBounds, { pane: 'patrol' });
    const topographyLayer = L.imageOverlay('topography-layer.png', imageBounds, { pane: 'topography' });

    const labelGroups = {
      "btn-lakes": L.layerGroup(),
      "btn-rivers": L.layerGroup(),
      "btn-outposts": L.layerGroup(),
      "btn-landmarks": L.layerGroup(),
    };
    labelGroups["btn-lakes"].addLayer(createLabelFromPixels(2900, 770, "North<br>Lake"));
    labelGroups["btn-lakes"].addLayer(createLabelFromPixels(1780, 1540, "Highlands<br>Lake"));
    

    labelGroups["btn-rivers"].addLayer(createLabelFromPixels(2605, 2175, "Delta"));

    labelGroups["btn-outposts"].addLayer(createLabelFromPixels(870, 1535, "Site Kappa-6"));
    labelGroups["btn-outposts"].addLayer(createLabelFromPixels(2140, 1660, "Site Kappa-13"));
    labelGroups["btn-outposts"].addLayer(createLabelFromPixels(3444, 1490, "Site Iota-21"));
    labelGroups["btn-outposts"].addLayer(createLabelFromPixels(2530, 600, "Site Delta-15"));
    labelGroups["btn-outposts"].addLayer(createLabelFromPixels(2680, 2100, "Site Nu-16"));
    labelGroups["btn-outposts"].addLayer(createLabelFromPixels(1800, 686, "Site Epsilon-11"));
    labelGroups["btn-outposts"].addLayer(createLabelFromPixels(3500, 1060, "Site Eta-21"));

    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(2990, 1420, "Roaring<br>Falls"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(2750, 1660, "Split<br>Rock"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(950, 2680, "Snakehead<br>Lagoon"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(1616, 1940, "Triangle<br>Pass"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(1600, 1700, "Highlands<br>Underpass"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(1270, 1520, "Highlands<br>Ravine"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(1345, 2228, "South Plains<br>Gorge"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(1160, 1050, "Skipping<br>Islands"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(1020, 850, "Key Hole"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(1175, 1270, "Stone Arch"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(1380, 2880, "Swamp<br>Ravine"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(735, 2270, "West Rail<br>Sandbars"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(350, 1430, "West Access<br> Sandbars"));


    const toggleableLayers = {
      "btn-water": waterLayer,
      "btn-salt": saltLayer,
      "btn-mud": mudLayer,
      "btn-road": roadLayer,
      "btn-structure": structureLayer,
      "btn-sanctuary": sanctuaryLayer,
      "btn-migration": migrationLayer,
      "btn-patrol": patrolLayer,

      "btn-regions": L.imageOverlay('regions-layer.png', imageBounds, { pane: 'structure', opacity: 0.8 }),
      "btn-tunnels": L.imageOverlay('tunnels-layer.png', imageBounds, { pane: 'structure', opacity: 0.8 }),
      "btn-fences": L.imageOverlay('fences-layer.png', imageBounds, { pane: 'structure', opacity: 0.8 }),
      "btn-trails": L.imageOverlay('trails-layer.png', imageBounds, { pane: 'road', opacity: 0.8 }),
      "btn-slipstreams": L.imageOverlay('slipstreams-layer.png', imageBounds, { pane: 'road', opacity: 0.8 }),
      "btn-thermals": L.imageOverlay('thermals-layer.png', imageBounds, { pane: 'road', opacity: 0.8 }),
      "btn-lakes": labelGroups["btn-lakes"],
      "btn-rivers": labelGroups["btn-rivers"],
      "btn-outposts": labelGroups["btn-outposts"],
      "btn-landmarks": labelGroups["btn-landmarks"],
    };

    function fromPixelCoords(x, y) {
      const lat = mapSize - y;
      const lng = x;
      return [lat, lng];
    }

    function createLabelFromPixels(x, y, text) {
      const [lat, lng] = fromPixelCoords(x, y);
      return createLabel(lat, lng, text);
    }

    function pressButtonImage(button, pressedSrc, defaultSrc, delay = 150) {
      button.src = pressedSrc;
      button.style.pointerEvents = 'none';

      setTimeout(() => {
        button.src = defaultSrc;
        button.style.pointerEvents = '';
      }, delay);
    }

    function createLabel(lat, lng, text) {
      return L.marker([lat, lng], {
        icon: L.divIcon({
          className: 'map-text-label',
          html: `<div>${text}</div>`,
          iconSize: [100, 20],
          iconAnchor: [50, 10]
        }),
        pane: 'labels',
        interactive: false
      });
    }

    for (const [buttonId, layer] of Object.entries(toggleableLayers)) {
      const button = document.getElementById(buttonId);
      if (!button) continue;

      button.addEventListener('click', function () {
        const clickSound = document.getElementById('click-sound');
        clickSound.currentTime = 0;
        clickSound.play();

        const isActive = button.dataset.state === "on";

        if (!isActive) {
          layer.addTo(map);
          button.src = "layerbutton-on.png";
          button.dataset.state = "on";
        } else {
          map.removeLayer(layer);
          button.src = "layerbutton-off.png";
          button.dataset.state = "off";
        }
      });
    }
    function catmullRomSpline(points, segments = 16) {
      if (points.length < 2) return [];

      const curve = [];
      for (let i = 0; i < points.length - 1; i++) {
        const p0 = points[i - 1] || points[i];
        const p1 = points[i];
        const p2 = points[i + 1];
        const p3 = points[i + 2] || p2;

        for (let j = 0; j < segments; j++) {
          const t = j / segments;
          const t2 = t * t;
          const t3 = t2 * t;

          const lat =
            0.5 * (
              (2 * p1.lat) +
              (-p0.lat + p2.lat) * t +
              (2 * p0.lat - 5 * p1.lat + 4 * p2.lat - p3.lat) * t2 +
              (-p0.lat + 3 * p1.lat - 3 * p2.lat + p3.lat) * t3
            );

          const lng =
            0.5 * (
              (2 * p1.lng) +
              (-p0.lng + p2.lng) * t +
              (2 * p0.lng - 5 * p1.lng + 4 * p2.lng - p3.lng) * t2 +
              (-p0.lng + 3 * p1.lng - 3 * p2.lng + p3.lng) * t3
            );

          curve.push([lat, lng]);
        }
      }

      curve.push([points[points.length - 1].lat, points[points.length - 1].lng]);
      return curve;
    }

    let mapVisible = false;
    let tickleCount = 0;
    let measureControl = null;
    window.addEventListener('load', () => {
      btnGrid = document.getElementById('btn-grid');
      gridLayerGroup = L.layerGroup();

      const coordInputField = document.getElementById('coord-full');
      const clickSound = document.getElementById('click-sound');

      // Press animation helper
      function pressBtn(btn, delay = 100) {
        const src = btn.src.replace('.png', '');
        pressButtonImage(btn, `${src}-in.png`, `${src}.png`, delay);
      }

      // Number input buttons
      document.querySelectorAll('.numpad-btn[data-num]').forEach(btn => {
        btn.addEventListener('click', () => {
          clickSound.currentTime = 0;
          clickSound.play();
          pressBtn(btn);
          coordInputField.value += btn.dataset.num;
        });
      });

      const btnSpace = document.getElementById('btn-numpad-space');
      btnSpace.addEventListener('click', () => {
        clickSound.currentTime = 0;
        clickSound.play();
        pressBtn(btnSpace);
        coordInputField.value += ' ';
      });

      // Confirm button = ENTER
      const btnConfirm = document.getElementById('btn-numpad-confirm');
      btnConfirm.addEventListener('click', (e) => {
        clickSound.currentTime = 0;
        clickSound.play();
        pressBtn(btnConfirm);
        gotoCoord();
        coordInputField.value = '';
      });

      // Clear button = same as btn-clear-coords
      const btnClear = document.getElementById('btn-numpad-clear');
      btnClear.addEventListener('click', (e) => {
        clickSound.currentTime = 0;
        clickSound.play();
        pressBtn(btnClear);
        clearCoordPath();
      });

      const cellSize = 4096 / 24;
      const greek = [
        "α", "β", "γ", "δ", "ε", "ζ", "η", "θ", "ι", "κ", "λ", "μ",
        "ν", "ξ", "ο", "π", "ρ", "σ", "τ", "υ", "φ", "χ", "ψ", "ω"
      ];

      // Add grid lines
      for (let i = 1; i < 24; i++) {
        const x = i * cellSize;
        const y = i * cellSize;
        gridLayerGroup.addLayer(L.polyline([[0, x], [4096, x]], { color: '#00ff00', weight: 1, opacity: 0.3 }));
        gridLayerGroup.addLayer(L.polyline([[y, 0], [y, 4096]], { color: '#00ff00', weight: 1, opacity: 0.3 }));
      }

      // Add labels
      for (let i = 0; i < 24; i++) {
        const offset = (i + 0.5) * cellSize;


      }

      const btnTickle = document.getElementById('btn-tickletoggle');

      btnTickle.addEventListener('click', () => {
        const isOn = btnTickle.dataset.state === "on";
        const clickSound = document.getElementById('click-sound');
        clickSound.currentTime = 0;
        clickSound.play();

        if (!isOn) {
          btnTickle.src = "tickletoggle-on.png";
          btnTickle.dataset.state = "on";

          if (mapVisible) {
            tickleCount++;
            const counter = document.getElementById('tickle-counter');
            counter.innerText = `${tickleCount}`;
          }
        } else {
          btnTickle.src = "tickletoggle-off.png";
          btnTickle.dataset.state = "off";
        }
      });


      const floatLabelContainer = document.createElement('div');
      floatLabelContainer.id = 'floating-labels';
      floatLabelContainer.style.display = 'none';
      document.getElementById('map-container').appendChild(floatLabelContainer);

      const rowLabels = [];
      const colLabels = [];

      for (let i = 0; i < 24; i++) {
        const row = document.createElement('div');
        row.className = 'floating-label';
        row.innerText = greek[i];
        floatLabelContainer.appendChild(row);
        rowLabels.push({ el: row, lat: 4096 - (i + 0.5) * cellSize });

        const col = document.createElement('div');
        col.className = 'floating-label';
        col.innerText = (i + 1).toString();
        floatLabelContainer.appendChild(col);
        colLabels.push({ el: col, lng: (i + 0.5) * cellSize });
      }

      function updateFloatingLabels() {
        const size = map.getSize();

        // Greek Y-axis (float up/down)
        rowLabels.forEach(({ el, lat }) => {
          const point = map.latLngToContainerPoint([lat, 0]);
          const clampedX = Math.min(Math.max(50, point.x), size.x - 40);
          el.style.left = clampedX + "px";
          el.style.top = (point.y - 8) + "px";
        });

        // Number X-axis (float left/right near top)
        colLabels.forEach(({ el, lng }) => {
          const point = map.latLngToContainerPoint([map.getBounds().getNorth(), lng]);
          const clampedY = Math.min(Math.max(50, point.y), size.y - 40);
          el.style.left = (point.x - 8) + "px";
          el.style.top = clampedY + "px";
        });
      }



      btnGrid.addEventListener('click', () => {
        const isOn = btnGrid.dataset.state === "on";
        const lightGrid = document.getElementById('light-grid');
        const clickSound = document.getElementById('click-sound');
        clickSound.currentTime = 0;
        clickSound.play();



        if (!isOn) {
          gridLayerGroup.addTo(map);
          btnGrid.src = "modebutton-on.png";
          btnGrid.dataset.state = "on";
          floatLabelContainer.style.display = 'block';
          map.on('move zoom', updateFloatingLabels);
          updateFloatingLabels();
          if (mapVisible && lightGrid) lightGrid.src = "indicator-on.png";
        } else {
          map.removeLayer(gridLayerGroup);
          btnGrid.src = "modebutton-off.png";
          btnGrid.dataset.state = "off";
          floatLabelContainer.style.display = 'none';
          map.off('move zoom', updateFloatingLabels);
          if (mapVisible && lightGrid) lightGrid.src = "indicator-off.png";
        }
      });

      const btnTopoMode = document.getElementById('btn-topo-mode');
      btnTopoMode.addEventListener('click', () => {
        const lightGrid = document.getElementById('light-topo');
        const isOn = btnTopoMode.dataset.state === "on";
        const clickSound = document.getElementById('click-sound');
        clickSound.currentTime = 0;
        clickSound.play();



        if (!isOn) {
          topographyLayer.addTo(map);
          btnTopoMode.src = "modebutton-on.png";
          btnTopoMode.dataset.state = "on";
          if (mapVisible && lightGrid) lightGrid.src = "indicator-on.png";
        } else {
          map.removeLayer(topographyLayer);
          btnTopoMode.src = "modebutton-off.png";
          btnTopoMode.dataset.state = "off";
          if (mapVisible && lightGrid) lightGrid.src = "indicator-off.png";
        }
      });

      const btnMeasure = document.getElementById('btn-measure');
      btnMeasure.addEventListener('click', () => {
        const isOn = btnMeasure.dataset.state === "on";
        const clickSound = document.getElementById('click-sound');
        clickSound.currentTime = 0;
        clickSound.play();

        // Always play the press animation
        pressButtonImage(btnMeasure, "measure-on.png", "measure-off.png", 120);

        // Do NOT toggle the measure mode if map is off
        if (!mapVisible) return;

        if (!isOn) {
          startCustomMeasuring();
          btnMeasure.dataset.state = "on";
        } else {
          stopCustomMeasuring();
          btnMeasure.dataset.state = "off";
        }
      });


      const btnBase1 = document.getElementById('btn-base1');
      btnBase1.addEventListener('click', () => {
        const lightGrid = document.getElementById('light-base1');
        const isOn = btnBase1.dataset.state === "on";
        const clickSound = document.getElementById('click-sound');
        clickSound.currentTime = 0;
        clickSound.play();



        if (!isOn) {
          base1Layer.addTo(map);
          btnBase1.src = "modebutton-on.png";
          btnBase1.dataset.state = "on";
          if (mapVisible && lightGrid) lightGrid.src = "indicator-on.png";
        } else {
          map.removeLayer(base1Layer);
          btnBase1.src = "modebutton-off.png";
          btnBase1.dataset.state = "off";
          if (mapVisible && lightGrid) lightGrid.src = "indicator-off.png";
        }
      });

      const btnContrastMode = document.getElementById('btn-contrast-mode');

      btnContrastMode.addEventListener('click', () => {
        const lightGrid = document.getElementById('light-contrast');
        const isOn = btnContrastMode.dataset.state === "on";
        const clickSound = document.getElementById('click-sound');
        clickSound.currentTime = 0;
        clickSound.play();

  

        const mapContainer = document.getElementById('map-container');

        if (!isOn) {
          mapContainer.classList.add('grayscale');
          btnContrastMode.src = "modebutton-on.png";
          btnContrastMode.dataset.state = "on";
          if (mapVisible && lightGrid) lightGrid.src = "indicator-on.png";
        } else {
          mapContainer.classList.remove('grayscale');
          btnContrastMode.src = "modebutton-off.png";
          btnContrastMode.dataset.state = "off";
          if (mapVisible && lightGrid) lightGrid.src = "indicator-off.png";
        }
      });

      map.invalidateSize();
      setMinZoomToFitViewport(100);
      const startZoom = map.getMinZoom() + 0.3;
      map.setView([2048, 2048], startZoom);

      const categoryButtons = {
        'btn-cat-zones': 'cat-zones',
        'btn-cat-env': 'cat-env',
        'btn-cat-manmade': 'cat-manmade',
        'btn-cat-traversal': 'cat-traversal',
        'btn-cat-labels': 'cat-labels',
      };

      const categoryButtonImages = {
        'btn-cat-zones': { default: 'button-a.png', pressed: 'button-a-in.png' },
        'btn-cat-env': { default: 'button-b.png', pressed: 'button-b-in.png' },
        'btn-cat-manmade': { default: 'button-c.png', pressed: 'button-c-in.png' },
        'btn-cat-traversal': { default: 'button-d.png', pressed: 'button-d-in.png' },
        'btn-cat-labels': { default: 'button-e.png', pressed: 'button-e-in.png' },
      };

      const categoryDescriptions = {
        'cat-zones': { name: 'ZONES', layers: ['Patrol-1', 'Migration-2', 'Sanctuary-3'] },
        'cat-env': { name: 'ENVIRONMENT', layers: ['Water-1', 'Salt-2', 'Mud-3'] },
        'cat-manmade': { name: 'MANMADE', layers: ['Road-1', 'Structure-2'] },
        'cat-traversal': { name: 'TRAVERSAL', layers: ['Trails-1', 'Slipstreams-2', 'Thermals-3'] },
        'cat-labels': { name: 'LABELS', layers: ['Lakes-1', 'Rivers-2', 'Outposts-3', 'Landmarks-4'] }
      };

      const defaultInfoContent = `
        <strong>CATEGORIES</strong>
        <span>1-Zones</span>
        <span>2-Environment</span>
        <span>3-Manmade</span>
        <span>4-Traversal</span>
        <span>5-Labels</span>
      `;

      let activeCategory = null;

      for (const [btnId, catId] of Object.entries(categoryButtons)) {
        const btn = document.getElementById(btnId);
        const cat = document.getElementById(catId);
        const light = document.getElementById(`light-${catId}`);
        const infoBox = document.getElementById('category-info-box');

        btn.addEventListener('click', () => {
          const isOn = btn.dataset.state === "on";
          const clickSound = document.getElementById('click-sound');
          clickSound.currentTime = 0;
          clickSound.play();

          const imgSet = categoryButtonImages[btnId];
          if (imgSet) {
            pressButtonImage(btn, imgSet.pressed, imgSet.default, 150);
          }

          if (!mapVisible) return;

          const cat = document.getElementById(catId);
          const light = document.getElementById(`light-${catId}`);
          const infoBox = document.getElementById('category-info-box');

          document.querySelectorAll('.overlay-category').forEach(div => div.style.display = 'none');

          if (isOn) {
            btn.dataset.state = "off";
            if (light) light.src = "indicator-off.png";
            activeCategory = null;
            document.getElementById('dummy-fillers').style.display = 'block';
            infoBox.innerHTML = defaultInfoContent;
            infoBox.style.display = 'block';
            infoBox.classList.add('default-list-mode');
            setInfoBoxAlignment("left");
          } else {
            document.querySelectorAll('.category-toggle').forEach(otherBtn => {
              otherBtn.dataset.state = "off";
            });
            document.querySelectorAll('.category-light').forEach(lightEl => {
              lightEl.src = "indicator-off.png";
            });

            btn.dataset.state = "on";
            if (light) light.src = "indicator-on.png";

            cat.style.display = 'block';
            activeCategory = catId;
            document.getElementById('dummy-fillers').style.display = 'none';

            const desc = categoryDescriptions[catId];
            if (desc) {
              infoBox.innerHTML = `<strong>${desc.name}</strong>` + desc.layers.map(layer => `<span>${layer}</span>`).join('');
              infoBox.style.display = 'block';
              infoBox.classList.remove('default-list-mode');
              setInfoBoxAlignment("right");
            }
          }
        });
      }



      const btnMapOn = document.getElementById('btn-map-on');
      const btnMapOff = document.getElementById('btn-map-off');

      btnMapOn.addEventListener('click', () => {
        pressButtonImage(btnMapOn, 'switch-on-in.png', 'switch-on.png');
        toggleMap(true);
      });

      btnMapOff.addEventListener('click', () => {
        pressButtonImage(btnMapOff, 'switch-off-in.png', 'switch-off.png');
        toggleMap(false);
      });

      const soundOn = document.getElementById('sound-on');
      const soundOff = document.getElementById('sound-off');
      soundOn.volume = 1.0;
      soundOff.volume = 1.0;
      const statusLight = document.getElementById('status-light');
      const mapContainer = document.getElementById('map-container');

      function toggleMap(turnOn) {
        if (turnOn === mapVisible) return; // Already in desired state

        if (turnOn) {
          document.getElementById('coord-input').style.display = 'block';
          mapContainer.style.display = 'block';
          coordInputField.value = '';
          setTimeout(() => {
            mapContainer.style.opacity = '1';
            map.invalidateSize();
            setMinZoomToFitViewport(100);
          }, 10);

          if (btnGrid.dataset.state === "on") {
            gridLayerGroup.addTo(map);
            document.getElementById('light-grid').src = "indicator-on.png";
          }

          if (btnTopoMode.dataset.state === "on") {
            topographyLayer.addTo(map);
            document.getElementById('light-topo').src = "indicator-on.png";
          }

          if (btnBase1.dataset.state === "on") {
            base1Layer.addTo(map);
            document.getElementById('light-base1').src = "indicator-on.png";
          }

          if (btnContrastMode.dataset.state === "on") {
            mapContainer.classList.add('grayscale');
            document.getElementById('light-contrast').src = "indicator-on.png";
          }

          soundOn.currentTime = 0;
          soundOn.play();
          document.getElementById('tickle-counter').style.display = 'block';
          statusLight.src = 'light-on.png';

          const infoBox = document.getElementById('category-info-box');
          if (!activeCategory) {
            infoBox.innerHTML = defaultInfoContent;
            infoBox.classList.add('default-list-mode');
            setInfoBoxAlignment("left");
            infoBox.style.display = 'block';
            infoBox.classList.add('default-list-mode');
          }
        } else {
          document.getElementById('coord-input').style.display = 'none';
          mapContainer.style.opacity = '0';
          setTimeout(() => {
            mapContainer.style.display = 'none';
          }, 300);

          const gif = document.getElementById('easteregg-gif');
          gif.style.opacity = '0';
          gif.style.display = 'none';
          easterEggVisible = false;
          document.getElementById('tickle-counter').style.display = 'none';

          soundOff.currentTime = 0;
          soundOff.play();
          stopCustomMeasuring();
          statusLight.src = 'light-off.png';

          document.querySelectorAll('.category-light').forEach(light => {
            light.src = "indicator-off.png";
          });

          document.querySelectorAll('.layer-toggle').forEach(btn => {
            btn.src = "layerbutton-off.png";
            btn.dataset.state = "off";
          });

          Object.values(toggleableLayers).forEach(layer => {
            if (map.hasLayer(layer)) {
              map.removeLayer(layer);
            }
          });

          document.querySelectorAll('.overlay-category').forEach(div => div.style.display = 'none');
          document.getElementById('dummy-fillers').style.display = 'block';

          const infoBox = document.getElementById('category-info-box');
          infoBox.innerHTML = '';
          infoBox.style.display = 'none';

          activeCategory = null;
        }

        mapVisible = turnOn;
      }


      window.addEventListener('resize', () => {
        if (mapVisible) {
          setMinZoomToFitViewport(100);
        }

      const gif = document.getElementById('easteregg-gif');
      gif.style.opacity = '0';
      gif.style.display = 'none';
      easterEggVisible = false;
      window.eastereggGif = gif; 
      });

      let customMeasureActive = false;
      let customLine = null;
      let customDistance = 0;
      let curvedPoints = [];
      let smoothCurveLayer = null;
      let startMarker = null;
      let endMarker = null;
      const measureDisplay = document.getElementById('measure-display');

      function createEndpointMarker(latlng) {
        return L.circleMarker(latlng, {
          radius: 4,
          color: '#ffffff',
          fillColor: '#ffffff',
          fillOpacity: 1,
          weight: 1,
          pane: 'measure'
        }).addTo(map);
      }

      function updateEndpointMarkers() {
        if (curvedPoints.length === 0) return;

        const start = curvedPoints[0];
        const end = curvedPoints[curvedPoints.length - 1];

        if (!startMarker) {
          startMarker = createEndpointMarker(start);
        } else {
          startMarker.setLatLng(start);
        }

        // Always update or recreate endMarker
        if (endMarker) {
          map.removeLayer(endMarker);
        }
        endMarker = createEndpointMarker(end);
      }

      function startCustomMeasuring() {
        customMeasureActive = true;
        customLine = L.featureGroup().addTo(map);


        customPoints = [];
        customDistance = 0;
        curvedPoints = [];
        smoothCurveLayer = null;
        measureDisplay.innerText = "Click to measure";
        measureDisplay.style.display = "block";
      }

      function clearCoordPath() {
        coordPathPoints = [];
        coordLayerGroup.clearLayers();
        coordPathLayer = null;
        markerLayer = null;
      }

      function stopCustomMeasuring() {
        customMeasureActive = false;
        if (customLine) map.removeLayer(customLine);
        customLine = null;
        customDistance = 0;
        curvedPoints = [];
        if (smoothCurveLayer) {
          map.removeLayer(smoothCurveLayer);
          smoothCurveLayer = null;
        }
        measureDisplay.style.display = "none";

        if (startMarker) {
          map.removeLayer(startMarker);
          startMarker = null;
        }
        if (endMarker) {
          map.removeLayer(endMarker);
          endMarker = null;
        }
      }

      map.on('click', function (e) {
        if (!customMeasureActive) return;

        const latlng = e.latlng;
        curvedPoints.push(latlng);

        const smoothLatLngs = catmullRomSpline(curvedPoints);

        if (smoothCurveLayer) {
          customLine.removeLayer(smoothCurveLayer);
        }

        smoothCurveLayer = L.polyline(smoothLatLngs, {
          color: '#ffffff',
          weight: 2.5,
          opacity: 0.9,
          dashArray: '6,4',
          interactive: false,
          pane: 'measure'
        }).addTo(customLine);

        if (curvedPoints.length > 1) {
          const prev = curvedPoints[curvedPoints.length - 2];
          const pixelDist = map.distance(prev, latlng);
          const meters = pixelDist * 3.11084; // ✅ correct conversion factor
          customDistance += meters;

          if (customDistance >= 1000) {
            measureDisplay.innerText = `${(customDistance / 1000).toFixed(2)} km`;
          } else {
            measureDisplay.innerText = `${customDistance.toFixed(1)} m`;
          }

          updateEndpointMarkers();
        }
      });
      document.addEventListener('keydown', (e) => {
        if (!customMeasureActive) return;

        if (e.ctrlKey && e.key === 'z') {
          e.preventDefault();

          if (curvedPoints.length > 0) {
            const removed = curvedPoints.pop();

            if (smoothCurveLayer) {
              customLine.removeLayer(smoothCurveLayer);
              smoothCurveLayer = null;
            }

            if (curvedPoints.length >= 2) {
              const smoothLatLngs = catmullRomSpline(curvedPoints);
              smoothCurveLayer = L.polyline(smoothLatLngs, {
                color: '#ffffff',
                weight: 2.5,
                opacity: 0.9,
                dashArray: '6,4',
                interactive: false
              }).addTo(customLine);
            }

            if (curvedPoints.length > 0) {
              const prev = curvedPoints[curvedPoints.length - 1];
              const dist = map.distance(prev, removed) * 3.11084;
              customDistance -= dist;

              if (customDistance >= 1000) {
                measureDisplay.innerText = `${(customDistance / 1000).toFixed(2)} km`;
              } else {
                measureDisplay.innerText = `${customDistance.toFixed(1)} m`;
              }
            } else {
              measureDisplay.innerText = `Click to measure`;
            }
            if (curvedPoints.length === 0) {
              measureDisplay.innerText = `Click to measure`;

              if (startMarker) {
                map.removeLayer(startMarker);
                startMarker = null;
              }
              if (endMarker) {
                map.removeLayer(endMarker);
                endMarker = null;
              }
            }
            updateEndpointMarkers();
          }
        }
      });



    });

    let markerLayer = null;

    function parsePlayerCoord(input) {
      const raw = input.trim();
      const europeanPattern = /(\d{1,3}(?: \d{3})+,\d+)/;

      if (europeanPattern.test(raw)) {
        const normalized = raw
          .replace(/ /g, '')
          .replace(/,/g, '.');

        const matches = normalized.match(/-?\d+(\.\d+)?/g);

        if (!matches || matches.length < 2) {
          alert('Invalid coordinate format (EU-style).');
          return null;
        }

        return {
          x: parseFloat(matches[0]),
          y: parseFloat(matches[1]),
        };
      }

      const standard = raw.replace(/,/g, '');
      const matches = standard.match(/-?\d+(\.\d+)?/g);

      if (!matches || matches.length < 2) {
        alert('Invalid coordinate format.');
        return null;
      }

      return {
        x: parseFloat(matches[0]),
        y: parseFloat(matches[1]),
      };
    }

    function gotoCoord() {
      const input = document.getElementById('coord-full').value.trim().toUpperCase();

      if (input === "505") return toggleGoreOverlay();
      if (input === "PR1D3") return activateRainbowMode();
      if (input === "80085") return toggleEasterEggGif();

      const parsed = parsePlayerCoord(input);
      if (!parsed) return;

      const pxX = 0.00002517 * parsed.x + 0.00331425 * parsed.y + 1853.23;
      const pxY = 0.00331419 * parsed.x + 0.00004456 * parsed.y + 1981.76;
      const latlng = L.latLng(mapSize - pxY, pxX);

      if (coordPathPoints.length >= 1) {
        const prev = coordPathPoints[coordPathPoints.length - 1];

        if (coordPathPoints.length > 1) {
          coordLayerGroup.addLayer(L.circleMarker(prev, {
            radius: 2.5,
            color: '#c0ffc0',
            fillColor: '#c0ffc0',
            fillOpacity: 0.2,
            weight: 1,
            pane: 'measure'
          }));
        }

        if (coordPathPoints.length === 1) {
          coordLayerGroup.addLayer(L.circleMarker(prev, {
            radius: 4,
            color: '#c0ffc0',
            fillColor: '#c0ffc0',
            fillOpacity: 1,
            weight: 1,
            pane: 'measure'
          }));
        }
      }

      coordPathPoints.push(latlng);

      if (coordPathPoints.length >= 2) {
        if (coordPathLayer) {
          coordLayerGroup.removeLayer(coordPathLayer);
        }

        coordPathLayer = L.polyline(coordPathPoints, {
          color: '#c0ffc0',
          weight: 2.5,
          opacity: 0.9,
          dashArray: '6,4',
          interactive: false,
          pane: 'measure'
        });

        coordLayerGroup.addLayer(coordPathLayer);
      }

      if (markerLayer) {
        coordLayerGroup.removeLayer(markerLayer);
      }

      markerLayer = L.marker(latlng, {
        icon: L.divIcon({
          className: 'pulse-marker',
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        }),
        pane: 'measure'
      });

      coordLayerGroup.addLayer(markerLayer);

      map.setView(latlng, map.getZoom());
    }



    document.getElementById('coord-full').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        gotoCoord();
        this.value = '';
      }
    });

    goreOverlay = document.createElement('img');
    goreOverlay.src = 'map-gore.png';
    goreOverlay.style.position = 'fixed';
    goreOverlay.style.top = '50%';
    goreOverlay.style.left = '50%';
    goreOverlay.style.width = '100dvh';
    goreOverlay.style.height = '100dvh';
    goreOverlay.style.transform = 'translate(-50%, -50%)';
    goreOverlay.style.zIndex = '999999';
    goreOverlay.style.pointerEvents = 'none';
    goreOverlay.style.opacity = '0';
    goreOverlay.style.transition = 'opacity 0.8s ease-in-out';
    document.body.appendChild(goreOverlay);

    function toggleGoreOverlay() {
      goreOverlayVisible = !goreOverlayVisible;

      if (goreOverlayVisible) {
        goreOverlay.style.display = 'block';
        requestAnimationFrame(() => {
          goreOverlay.style.opacity = '1';
        });
      } else {
        goreOverlay.style.opacity = '0';
        setTimeout(() => {
          goreOverlay.style.display = 'none';
        }, 800);
      }
    }

    function activateRainbowMode() {
      const mapContainer = document.getElementById('map-container');

      const isRainbow = mapContainer.classList.contains('rainbow-mode');
      mapContainer.classList.remove('rainbow-mode');
      if (!isRainbow) {
        mapContainer.classList.add('rainbow-mode');
      }
    }

    let easterEggVisible = false;

    function toggleEasterEggGif() {
      const gif = document.getElementById('easteregg-gif');

      // Prevent showing if screen is off
      if (!mapVisible) return;

      easterEggVisible = !easterEggVisible;

      if (easterEggVisible) {
        gif.style.display = 'block';
        requestAnimationFrame(() => {
          gif.style.opacity = '1';
        });
      } else {
        gif.style.opacity = '0';
        setTimeout(() => {
          gif.style.display = 'none';
        }, 600);
      }
    }


  </script>
<img src="gapfix.png" id="gap-fix-overlay" />
<img id="easteregg-gif" src="easteregg.gif" style="
  position: fixed;
  bottom: 20%;
  left: 50%;
  transform: translateX(-50%);
  height: 60dvh;
  pointer-events: none;
  z-index: 2;
  opacity: 0;
  transition: opacity 0.6s ease-in-out;
  display: none;
" />
  <div id="discord-button" onclick="window.open('https://discord.gg/RenatusRP', '_blank')">
    <img src="discord-button.png" alt="Join our Discord">
  </div>
</body>
</html>
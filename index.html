<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Renatus Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/map/favicon.png">
  <link rel="shortcut icon" type="image/x-icon" href="/map/favicon.ico">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    html, body {
      margin: 0;
      height: 100dvh;
      background: #00000000;
      overflow: hidden;
    }

    #overlay-buttons {
      pointer-events: auto;
      z-index: 9999;
    }

    #btn-grid {
      pointer-events: auto;
      cursor: pointer;
      z-index: 9999;
    }

    #category-info-box {
      position: absolute;
      top: 7%;
      left: 2.2%;
      width: 16dvh;
      background: rgba(0, 0, 0, 0);
      color: rgba(171, 255, 171, 0.548);
      padding: 1dvh;
      font-family: 'Courier New', monospace;
      border-radius: 0.5dvh;
      font-size: 2.4dvh;
      z-index: 201;
      pointer-events: none;
      text-transform: uppercase;
      text-align: center;
    }

    #category-info-box span {
      display: block;
      font-size: 1.7dvh;
      font-weight: normal;
      text-transform: none;
      text-align: left;
      margin-top: 2.6dvh;
    }

    #category-info-box.default-list-mode span {
      margin-bottom: 0dvh;
      margin-top: 2.6dvh;
    }

    #control-panel-wrapper {
      position: fixed;
      top: 0;
      left: 50%;
      height: 100dvh;
      transform: translateX(-50%);
      z-index: 0;
      pointer-events: none;
    }

    #control-panel-base {
      height: 100dvh;
    }

    #tv-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 100dvh;
      height: 100dvh;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 3;
      background: url('tv-frame.png') center center no-repeat;
      background-size: contain;
    }
    
    #gap-fix-overlay {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      height: 100dvh;
      pointer-events: none;
      z-index: 99999;
      background-size: contain;
    }

    #floating-labels {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    .floating-label {
      position: absolute;
      color: #c0ffc0;
      font-family: 'Courier New', monospace;
      font-size: 2dvh;
      white-space: nowrap;
      text-shadow:
        0 0 2px #7fff7f,
        0 0 6px #aaffaa,
        0 0 12px #c0ffc0,
        0 0 18px #c0ffc0,
        0 0 24px #e0ffe0;
      pointer-events: none;
      z-index: 9999;
    }

      #background {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 100vw;
      height: 100vw;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: -1;
      background: url('background.png') center center no-repeat;
      background-size: contain;
    }
    #map-container {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 100dvh;
      height: 100dvh;
      transform: translate(-50%, -50%);
      max-width: 100dvh;
      max-height: 100dvh;
      overflow: hidden;
      opacity: 0;
      transition: opacity 1s ease-in;
      display: none;
      z-index: 1;
    }

    #map {
      width: 100%;
      height: 100%;
      z-index: 1;
      background: transparent;
    }

    #background-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('tv-background.png') center center no-repeat;
      background-size: cover;
      z-index: 0;
      pointer-events: none;
    }

    #coord-input {
      position: absolute;
      top: 43.3%;
      left: 8.3%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0);
      width: 18dvh;
      height: 3.8dvh;
      vertical-align: middle;
      font-size: 3.8dvh;
      padding: 0dvh;
      border-radius: 0.8dvh;
      font-family: 'Courier New', monospace;
      font-size: 1.8dvh;
      z-index: 9999;
      pointer-events: auto;
    }

    #coord-input input {
      width: 18dvh;
      height: 3.8h;
      font-size: 1.4dvh;
      font-family: 'Courier New', monospace;
      background: none;
      border: none;
      color: rgba(171, 255, 171, 0.74);
      outline: none;
      text-align: center;
      box-sizing: border-box;

      padding-top: 1.4dvh;
      padding-bottom: 0.4dvh;
      line-height: normal;
    }

#coord-input input::placeholder {
  color: #c0ffc0;
  opacity: 0.7;
}
    #overlay-buttons {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: auto;
      z-index: 200;
    }

    .map-toggle-btn {
      position: absolute;
      width: 4dvh;
      height: 4dvh;
      pointer-events: auto;
      transition: opacity 0.3s ease;
      cursor: pointer;
      opacity: 0.5;
    }

    .layer-toggle {
      width: 6.25dvh;
      height: 2.5dvh;
      opacity: 1;
    }

    .dummy-button {
      pointer-events: none;
      opacity: 1;
    }
    #btn-map-toggle {
      opacity: 1;
    }

    .status-light {
      position: absolute;
      width: 4dvh;
      height: 4dvh;
      pointer-events: none;
    }
    #btn-grid {
      pointer-events: auto;
      cursor: pointer;
      z-index: 9999;
    }
    #btn-map-toggle { top: 82.5%; left: 90.52%; transform: scale(4); }
    #status-light   { top: 5.8%; left: 90.52%; pointer-events: none; transform: scale(2.6); }

    .pulse-marker {
      width: 20px;
      height: 20px;
      position: relative;
      background: rgba(255, 0, 0, 0.8);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 999;
    }

    .map-text-label {
      font-family: 'Courier New', monospace;
      color: #c0ffc0; /* original green text */
      font-size: 1.6dvh;
      text-align: center;
      white-space: nowrap;
      pointer-events: none;
      text-shadow:
        0 0 2px #7fff7f,     /* soft core glow */
        0 0 6px #aaffaa,     /* lighter halo */
        0 0 12px #c0ffc0,    /* matches text */
        0 0 18px #c0ffc0,    /* soft outer aura */
        0 0 24px #e0ffe0;    /* subtle neon fade */
    }

    .pulse-marker::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      background: rgba(255, 0, 0, 0.4);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: pulse 1.5s ease-out infinite;
    }

    .mode-toggle {
      height: 10dvh;
      width: auto;
      opacity: 1 !important;
    }

    @keyframes pulse {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.8;
      }
      100% {
        transform: translate(-50%, -50%) scale(2.5);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <div id="control-panel-wrapper">
    <img id="control-panel-base" src="control-panel-base.png" alt="" />
    <div id="overlay-buttons">
      <img src="switch-off.png" id="btn-map-toggle" class="map-toggle-btn" style="opacity: 1;" draggable="false"/>
      <img src="light-off.png" id="status-light" class="status-light" />
      <img src="button-off.png" id="btn-cat-zones" class="map-toggle-btn category-toggle" data-category="cat-zones" data-state="off" style="top: 60%; left: 1.72%; opacity: 1;" draggable="false"/>
      <img src="button-off.png" id="btn-cat-env" class="map-toggle-btn category-toggle" data-category="cat-env" data-state="off" style="top: 60%; left: 4.365%; opacity: 1;" draggable="false"/>
      <img src="button-off.png" id="btn-cat-manmade" class="map-toggle-btn category-toggle" data-category="cat-manmade" data-state="off" style="top: 60%; left: 7.01%; opacity: 1;" draggable="false"/>
      <img src="button-off.png" id="btn-cat-traversal" class="map-toggle-btn category-toggle" data-category="cat-traversal" data-state="off" style="top: 60%; left: 9.655%; opacity: 1;" draggable="false"/>
      <img src="button-off.png" id="btn-cat-labels" class="map-toggle-btn category-toggle" data-category="cat-labels" data-state="off" style="top: 60%; left: 12.3%; opacity: 1;" draggable="false"/>
      <!-- CATEGORY CONTAINERS -->
      <div id="cat-zones" class="overlay-category" style="display:none;">
        <img src="layerbutton-off.png" id="btn-patrol" class="map-toggle-btn layer-toggle" data-state="off" style="top: 66%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-migration" class="map-toggle-btn layer-toggle" data-state="off" style="top: 70%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-sanctuary" class="map-toggle-btn layer-toggle" data-state="off" style="top: 74%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 78%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 82%; left: 1.72%;" draggable="false"/>
      </div>

      <div id="cat-env" class="overlay-category" style="display:none;">
        <img src="layerbutton-off.png" id="btn-water" class="map-toggle-btn layer-toggle" data-state="off" style="top: 66%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-salt" class="map-toggle-btn layer-toggle" data-state="off" style="top: 70%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-mud" class="map-toggle-btn layer-toggle" data-state="off" style="top: 74%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-topography" class="map-toggle-btn layer-toggle" style="top: 78%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 82%; left: 1.72%;" draggable="false"/>
      </div>

      <div id="cat-manmade" class="overlay-category" style="display:none;">
        <img src="layerbutton-off.png" id="btn-road" class="map-toggle-btn layer-toggle" data-state="off" style="top: 66%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-structure" class="map-toggle-btn layer-toggle" data-state="off" style="top: 70%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 74%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 78%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 82%; left: 1.72%;" draggable="false"/>
      </div>

      <div id="cat-traversal" class="overlay-category" style="display:none;">
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 66%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 70%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 74%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 78%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 82%; left: 1.72%;" draggable="false"/>
      </div>

      <div id="cat-labels" class="overlay-category" style="display:none;">
        <img src="layerbutton-off.png" id="btn-lakes" class="map-toggle-btn layer-toggle" data-state="off" style="top: 66%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-rivers" class="map-toggle-btn layer-toggle" data-state="off" style="top: 70%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-outposts" class="map-toggle-btn layer-toggle" data-state="off" style="top: 74%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" id="btn-landmarks" class="map-toggle-btn layer-toggle" data-state="off" style="top: 78%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 82%; left: 1.72%;" draggable="false"/>
      </div>

      <div id="dummy-fillers">
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 66%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 70%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 74%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 78%; left: 1.72%;" draggable="false"/>
        <img src="layerbutton-off.png" class="map-toggle-btn layer-toggle dummy-button" style="top: 82%; left: 1.72%;" draggable="false"/>
      </div>
      <img src="modebutton-off.png" id="btn-grid" class="map-toggle-btn mode-toggle" data-state="off" style="top: 48.2%; left: 11%;" draggable="false"/>
      <img src="modebutton-off.png" id="btn-grid" class="map-toggle-btn mode-toggle" data-state="off" style="top: 48.2%; left: 8%;" draggable="false"/>
      <img src="modebutton-off.png" id="btn-grid" class="map-toggle-btn mode-toggle" data-state="off" style="top: 48.2%; left: 5%;" draggable="false"/>
      <img src="modebutton-off.png" id="btn-grid" class="map-toggle-btn mode-toggle" data-state="off" style="top: 48.2%; left: 2%;" draggable="false"/>
      <div id="coord-input">
        <input type="text" id="coord-full" placeholder="Paste coords" />
      </div>

      <div id="category-info-box" style="display: none;"></div>
    </div>
  </div>

  <div id="map-container">
    <div id="background-overlay"></div>
    <div id="map"></div>
  </div>
  <div id="floating-labels" style="display: none;"></div>
  <div id="tv-overlay"></div>
  <div id="background"></div>

  <audio id="sound-on" src="monitor-on.mp3"></audio>
  <audio id="sound-off" src="monitor-off.mp3"></audio>
  <audio id="click-sound" src="click.mp3"></audio>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    let btnGrid;
    let gridLayerGroup;
    const mapLabels = [
    ];

    const map = L.map('map', {
      crs: L.CRS.Simple,
      zoomControl: false,
      maxBounds: [[0, 0], [4096, 4096]],
      maxBoundsViscosity: 1.0
    });

    function setMinZoomToFitViewport(maxHeightInDvh = 100) {
      const mapHeightInPixels = window.innerHeight * (maxHeightInDvh / 100);
      const mapWidthInPixels = map.getContainer().clientWidth;

      const scaleY = mapHeightInPixels / 4096;
      const scaleX = mapWidthInPixels / 4096;

      const scale = Math.min(scaleX, scaleY) * 0.9;
      const zoom = map.getScaleZoom(scale, 0);

      map.setMinZoom(zoom);
    }


    function setMinZoomToFitMap() {
      const bounds = [[0, 0], [4096, 4096]];
      const minZoom = map.getBoundsZoom(bounds, false); // false = fit inside view
      map.setMinZoom(minZoom);
    }

    setMinZoomToFitMap();

    const mapSize = 4096;
    const imageBounds = [[0, 0], [mapSize, mapSize]];

    map.createPane('base'); map.getPane('base').style.zIndex = 200;
    map.createPane('topography'); map.getPane('topography').style.zIndex = 250;
    map.createPane('water'); map.getPane('water').style.zIndex = 300;
    map.createPane('terrain'); map.getPane('terrain').style.zIndex = 400;
    map.createPane('road'); map.getPane('road').style.zIndex = 500;
    map.createPane('salt'); map.getPane('salt').style.zIndex = 600;
    map.createPane('mud'); map.getPane('mud').style.zIndex = 600;
    map.createPane('structure'); map.getPane('structure').style.zIndex = 700;
    map.createPane('sanctuary'); map.getPane('sanctuary').style.zIndex = 800;
    map.createPane('migration'); map.getPane('migration').style.zIndex = 850;
    map.createPane('patrol'); map.getPane('patrol').style.zIndex = 900;

    const baseLayer = L.imageOverlay('map-base.png', imageBounds, { pane: 'base' }).addTo(map);
    const terrainLayer = L.imageOverlay('terrain-line.png', imageBounds, { pane: 'terrain' }).addTo(map);

    const waterLayer = L.imageOverlay('water-layer.png', imageBounds, { pane: 'water' });
    const saltLayer = L.imageOverlay('salt-layer.png', imageBounds, { pane: 'salt', opacity: 0.8 });
    const mudLayer = L.imageOverlay('mud-layer.png', imageBounds, { pane: 'mud', opacity: 0.8 });
    const roadLayer = L.imageOverlay('road-layer.png', imageBounds, { pane: 'road', opacity: 0.8 });
    const structureLayer = L.imageOverlay('structure-layer.png', imageBounds, { pane: 'structure', opacity: 0.8 });
    const sanctuaryLayer = L.imageOverlay('sanctuary-layer.png', imageBounds, { pane: 'sanctuary' });
    const migrationLayer = L.imageOverlay('migration-layer.png', imageBounds, { pane: 'migration' });
    const patrolLayer = L.imageOverlay('patrol-layer.png', imageBounds, { pane: 'patrol' });
    const topographyLayer = L.imageOverlay('topography-layer.png', imageBounds, { pane: 'topography' });

    const labelGroups = {
      "btn-lakes": L.layerGroup(),
      "btn-rivers": L.layerGroup(),
      "btn-outposts": L.layerGroup(),
      "btn-landmarks": L.layerGroup(),
    };
    labelGroups["btn-lakes"].addLayer(createLabelFromPixels(2900, 770, "North<br>Lake"));
    labelGroups["btn-lakes"].addLayer(createLabelFromPixels(1780, 1540, "Highlands<br>Lake"));
    labelGroups["btn-lakes"].addLayer(createLabelFromPixels(950, 2680, "Snakehead<br>Lagoon"));

    labelGroups["btn-rivers"].addLayer(createLabelFromPixels(2560, 2220, "Delta"));

    labelGroups["btn-outposts"].addLayer(createLabelFromPixels(870, 1535, "Site Kappa-6"));
    labelGroups["btn-outposts"].addLayer(createLabelFromPixels(3444, 1540, "Site EL"));

    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(1000, 3070, "Raptor<br>Cliff"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(2320, 1275, "Ptera<br>Table"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(2990, 1420, "Roaring<br>Falls"));
    labelGroups["btn-landmarks"].addLayer(createLabelFromPixels(2750, 1660, "Split<br>Rock"));



    const toggleableLayers = {
      "btn-water": waterLayer,
      "btn-salt": saltLayer,
      "btn-mud": mudLayer,
      "btn-road": roadLayer,
      "btn-structure": structureLayer,
      "btn-sanctuary": sanctuaryLayer,
      "btn-migration": migrationLayer,
      "btn-patrol": patrolLayer,
      "btn-topography": topographyLayer,

      "btn-regions": L.imageOverlay('regions-layer.png', imageBounds, { pane: 'structure', opacity: 0.8 }),
      "btn-tunnels": L.imageOverlay('tunnels-layer.png', imageBounds, { pane: 'structure', opacity: 0.8 }),
      "btn-fences": L.imageOverlay('fences-layer.png', imageBounds, { pane: 'structure', opacity: 0.8 }),
      "btn-trails": L.imageOverlay('trails-layer.png', imageBounds, { pane: 'road', opacity: 0.8 }),
      "btn-slipstreams": L.imageOverlay('slipstreams-layer.png', imageBounds, { pane: 'road', opacity: 0.8 }),
      "btn-thermals": L.imageOverlay('thermals-layer.png', imageBounds, { pane: 'road', opacity: 0.8 }),
      "btn-lakes": labelGroups["btn-lakes"],
      "btn-rivers": labelGroups["btn-rivers"],
      "btn-outposts": labelGroups["btn-outposts"],
      "btn-landmarks": labelGroups["btn-landmarks"],
    };

    function fromPixelCoords(x, y) {
      const lat = mapSize - y;
      const lng = x;
      return [lat, lng];
    }

    function createLabelFromPixels(x, y, text) {
      const [lat, lng] = fromPixelCoords(x, y);
      return createLabel(lat, lng, text);
    }

    function createLabel(lat, lng, text) {
      return L.marker([lat, lng], {
        icon: L.divIcon({
          className: 'map-text-label',
          html: `<div>${text}</div>`,
          iconSize: [100, 20],
          iconAnchor: [50, 10]
        }),
        interactive: false
      });
    }

    for (const [buttonId, layer] of Object.entries(toggleableLayers)) {
      const button = document.getElementById(buttonId);
      if (!button) continue;

      button.addEventListener('click', function () {
        const clickSound = document.getElementById('click-sound');
        clickSound.currentTime = 0;
        clickSound.play();

        const isActive = button.dataset.state === "on";

        if (!isActive) {
          layer.addTo(map);
          button.src = "layerbutton-on.png";
          button.dataset.state = "on";
        } else {
          map.removeLayer(layer);
          button.src = "layerbutton-off.png";
          button.dataset.state = "off";
        }
      });
    }

    window.addEventListener('load', () => {
      btnGrid = document.getElementById('btn-grid');
      gridLayerGroup = L.layerGroup();

      const cellSize = 4096 / 24;
      const greek = [
        "α", "β", "γ", "δ", "ε", "ζ", "η", "θ", "ι", "κ", "λ", "μ",
        "ν", "ξ", "ο", "π", "ρ", "σ", "τ", "υ", "φ", "χ", "ψ", "ω"
      ];

      // Add grid lines
      for (let i = 1; i < 24; i++) {
        const x = i * cellSize;
        const y = i * cellSize;
        gridLayerGroup.addLayer(L.polyline([[0, x], [4096, x]], { color: '#00ff00', weight: 1, opacity: 0.3 }));
        gridLayerGroup.addLayer(L.polyline([[y, 0], [y, 4096]], { color: '#00ff00', weight: 1, opacity: 0.3 }));
      }

      // Add labels
      for (let i = 0; i < 24; i++) {
        const offset = (i + 0.5) * cellSize;


      }

      const floatLabelContainer = document.createElement('div');
      floatLabelContainer.id = 'floating-labels';
      floatLabelContainer.style.display = 'none';
      document.getElementById('map-container').appendChild(floatLabelContainer);

      const rowLabels = [];
      const colLabels = [];

      for (let i = 0; i < 24; i++) {
        const row = document.createElement('div');
        row.className = 'floating-label';
        row.innerText = greek[i];
        floatLabelContainer.appendChild(row);
        rowLabels.push({ el: row, lat: 4096 - (i + 0.5) * cellSize });

        const col = document.createElement('div');
        col.className = 'floating-label';
        col.innerText = (i + 1).toString();
        floatLabelContainer.appendChild(col);
        colLabels.push({ el: col, lng: (i + 0.5) * cellSize });
      }

      function updateFloatingLabels() {
        const size = map.getSize();

        // Greek Y-axis (float up/down)
        rowLabels.forEach(({ el, lat }) => {
          const point = map.latLngToContainerPoint([lat, 0]);
          const clampedX = Math.min(Math.max(50, point.x), size.x - 40);
          el.style.left = clampedX + "px";
          el.style.top = (point.y - 8) + "px";
        });

        // Number X-axis (float left/right near top)
        colLabels.forEach(({ el, lng }) => {
          const point = map.latLngToContainerPoint([map.getBounds().getNorth(), lng]);
          const clampedY = Math.min(Math.max(50, point.y), size.y - 40);
          el.style.left = (point.x - 8) + "px";
          el.style.top = clampedY + "px";
        });
      }



      btnGrid.addEventListener('click', () => {
        const isOn = btnGrid.dataset.state === "on";
        const clickSound = document.getElementById('click-sound');
        clickSound.currentTime = 0;
        clickSound.play();

        if (!mapVisible) return; // ✅ Don't toggle grid if TV is off

        if (!isOn) {
          gridLayerGroup.addTo(map);
          btnGrid.src = "modebutton-on.png";
          btnGrid.dataset.state = "on";
          floatLabelContainer.style.display = 'block';
          map.on('move zoom', updateFloatingLabels);
          updateFloatingLabels();
        } else {
          map.removeLayer(gridLayerGroup);
          btnGrid.src = "modebutton-off.png";
          btnGrid.dataset.state = "off";
          floatLabelContainer.style.display = 'none';
          map.off('move zoom', updateFloatingLabels);
        }
      });


      map.invalidateSize();
      setMinZoomToFitViewport(100);
      const startZoom = map.getMinZoom() + 0.3;
      map.setView([2048, 2048], startZoom);

      const categoryButtons = {
        'btn-cat-zones': 'cat-zones',
        'btn-cat-env': 'cat-env',
        'btn-cat-manmade': 'cat-manmade',
        'btn-cat-traversal': 'cat-traversal',
        'btn-cat-labels': 'cat-labels',
      };

      const categoryDescriptions = {
        'cat-zones': { name: 'ZONES', layers: ['- Patrol', '- Migration', '- Sanctuary'] },
        'cat-env': { name: 'ENVIRONMENT', layers: ['- Water', '- Salt', '- Mud', '- Topography'] },
        'cat-manmade': { name: 'MANMADE', layers: ['- Road', '- Structure'] },
        'cat-traversal': { name: 'TRAVERSAL', layers: ['- Trails', '- Slipstreams', '- Thermals'] },
        'cat-labels': { name: 'LABELS', layers: ['- Lakes', '- Rivers', '- Outposts', '- Landmarks'] }
      };

      const defaultInfoContent = `
        <strong>CATEGORIES</strong>
        <span>- Zones</span>
        <span>- Environment</span>
        <span>- Manmade</span>
        <span>- Traversal</span>
        <span>- Labels</span>
      `;

      let activeCategory = null;

      for (const [btnId, catId] of Object.entries(categoryButtons)) {
        const btn = document.getElementById(btnId);
        const cat = document.getElementById(catId);

        btn.addEventListener('click', () => {
          const clickSound = document.getElementById('click-sound');
          clickSound.currentTime = 0;
          clickSound.play();

          if (!mapVisible) return;

          document.querySelectorAll('.overlay-category').forEach(div => div.style.display = 'none');
          const infoBox = document.getElementById('category-info-box');

          const isOn = btn.dataset.state === "on";

          if (isOn) {
            btn.src = "button-off.png";
            btn.dataset.state = "off";
            activeCategory = null;
            document.getElementById('dummy-fillers').style.display = 'block';
            infoBox.innerHTML = defaultInfoContent;
            infoBox.style.display = 'block';
            infoBox.classList.add('default-list-mode');
          } else {
            document.querySelectorAll('.category-toggle').forEach(otherBtn => {
              otherBtn.src = "button-off.png";
              otherBtn.dataset.state = "off";
            });

            btn.src = "button-on.png";
            btn.dataset.state = "on";
            cat.style.display = 'block';
            activeCategory = catId;
            document.getElementById('dummy-fillers').style.display = 'none';

            const desc = categoryDescriptions[catId];
            if (desc) {
              infoBox.innerHTML = `<strong>${desc.name}</strong>` + desc.layers.map(layer => `<span>${layer}</span>`).join('');
              infoBox.style.display = 'block';
              infoBox.classList.remove('default-list-mode');
            }
          }
        });
      }

      const soundOn = document.getElementById('sound-on');
      const soundOff = document.getElementById('sound-off');
      soundOn.volume = 1.0;
      soundOff.volume = 1.0;

      const btnMapToggle = document.getElementById('btn-map-toggle');
      const statusLight = document.getElementById('status-light');
      const mapContainer = document.getElementById('map-container');
      let mapVisible = false;

      btnMapToggle.addEventListener('click', function () {
        if (!mapVisible) {
          mapContainer.style.display = 'block';
          setTimeout(() => {
            mapContainer.style.opacity = '1';
            map.invalidateSize();
            setMinZoomToFitViewport(100); // <-- call it here
          }, 10);

          soundOn.currentTime = 0;
          soundOn.play();

          btnMapToggle.src = 'switch-on.png';
          statusLight.src = 'light-on.png';

          const infoBox = document.getElementById('category-info-box');
          if (!activeCategory) {
            infoBox.innerHTML = defaultInfoContent;
            infoBox.style.display = 'block';
            infoBox.classList.add('default-list-mode');
          }
        } else {
          mapContainer.style.opacity = '0';
          setTimeout(() => {
            mapContainer.style.display = 'none';
          }, 300);

          soundOff.currentTime = 0;
          soundOff.play();

          btnMapToggle.src = 'switch-off.png';
          statusLight.src = 'light-off.png';

          document.querySelectorAll('.category-toggle').forEach(btn => {
            btn.src = "button-off.png";
            btn.dataset.state = "off";
          });

          document.querySelectorAll('.layer-toggle').forEach(btn => {
            btn.src = "layerbutton-off.png";
            btn.dataset.state = "off";
          });

          Object.values(toggleableLayers).forEach(layer => {
            if (map.hasLayer(layer)) {
              map.removeLayer(layer);
            }
          });

          document.querySelectorAll('.overlay-category').forEach(div => div.style.display = 'none');
          document.getElementById('dummy-fillers').style.display = 'block';

          const infoBox = document.getElementById('category-info-box');
          infoBox.innerHTML = '';
          infoBox.style.display = 'none';

          activeCategory = null;
        }

        mapVisible = !mapVisible;
      });
      window.addEventListener('resize', () => {
        if (mapVisible) {
          setMinZoomToFitViewport(100);
        }
      });

    });

    let markerLayer = null;

    function parsePlayerCoord(input) {
      const raw = input.trim();
      const europeanPattern = /(\d{1,3}(?: \d{3})+,\d+)/;

      if (europeanPattern.test(raw)) {
        const normalized = raw
          .replace(/ /g, '')
          .replace(/,/g, '.');

        const matches = normalized.match(/-?\d+(\.\d+)?/g);

        if (!matches || matches.length < 2) {
          alert('Invalid coordinate format (EU-style).');
          return null;
        }

        return {
          x: parseFloat(matches[0]),
          y: parseFloat(matches[1]),
        };
      }

      const standard = raw.replace(/,/g, '');
      const matches = standard.match(/-?\d+(\.\d+)?/g);

      if (!matches || matches.length < 2) {
        alert('Invalid coordinate format.');
        return null;
      }

      return {
        x: parseFloat(matches[0]),
        y: parseFloat(matches[1]),
      };
    }

    function gotoCoord() {
      const input = document.getElementById('coord-full').value;
      const parsed = parsePlayerCoord(input);
      if (!parsed) return;

      // Affine transform derived from calibration
      const pxX = 0.00002517 * parsed.x + 0.00331425 * parsed.y + 1853.23;
      const pxY = 0.00331419 * parsed.x + 0.00004456 * parsed.y + 1981.76;

      const lat = mapSize - pxY;
      const lng = pxX;

      if (markerLayer) map.removeLayer(markerLayer);

      const divIcon = L.divIcon({
        className: 'pulse-marker',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });

      markerLayer = L.marker([lat, lng], { icon: divIcon }).addTo(map);
      map.setView([lat, lng], map.getZoom());
    }

    document.getElementById('coord-full').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        gotoCoord();
      }
    });

  </script>
<img src="gapfix.png" id="gap-fix-overlay" />
</body>
</html>
